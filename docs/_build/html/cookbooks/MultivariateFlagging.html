
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Multivariate Flagging &#8212; SaQC 2.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="shortcut icon" href="../_static/SaQCLogoSmall.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Configuration Files" href="../documentation/ConfigurationFiles.html" />
    <link rel="prev" title="Outlier Detection and Flagging" href="OutlierDetection.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../documentation/ConfigurationFiles.html" title="Configuration Files"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="OutlierDetection.html" title="Outlier Detection and Flagging"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SaQC 2.0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Multivariate Flagging</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p><a class="reference external" href="https://www.ufz.de/"><img alt="ufzLogo" src="../_images/UFZLogo.png" style="width: 40%;" /></a> <a class="reference external" href="https://www.ufz.de/index.php?de=45348"><img alt="rdmLogo" class="align-right" src="../_images/RDMLogo.png" style="width: 22%;" /></a></p>
<section id="multivariate-flagging">
<h1>Multivariate Flagging<a class="headerlink" href="#multivariate-flagging" title="Permalink to this headline">¶</a></h1>
<p>The tutorial aims to introduce the usage of SaQC in the context of some more complex flagging and processing techniques.
Mainly we will see how to apply Drift Corrections onto the data and how to perform multivariate flagging.</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#data-preparation">Data Preparation</a></p></li>
<li><p><a class="reference internal" href="#drift-correction">Drift Correction</a></p></li>
<li><p><a class="reference internal" href="#multivariate-flagging-procedure">Multivariate Flagging Procedure</a></p></li>
<li><p><a class="reference internal" href="#config">Config</a></p></li>
</ol>
<section id="data-preparation">
<h2>Data Preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h2>
<p>First import the data (from the repository), and generate an saqc instance from it. You will need to download the <a class="reference external" href="https://git.ufz.de/rdm-software/saqc/-/blob/develop/docs/resources/data/hydro_data.csv">sensor
data</a> and the
<a class="reference external" href="https://git.ufz.de/rdm-software/saqc/-/blob/develop/docs/resources/data/hydro_maint.csv">maintenance data</a>
from the <a class="reference external" href="https://git.ufz.de/rdm-software/saqc.git">repository</a> and make variables <cite>datapath</cite> and <cite>maintpath</cite> be
paths pointing at those downloaded files. Note, that the <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC" title="saqc.SaQC"><code class="xref py py-class docutils literal notranslate"><span class="pre">SaQC</span></code></a> digests the loaded data in a list.
This is done, to circumvent having to concatenate both datasets in a pandas Dataframe instance, which would introduce
<cite>NaN</cite> values to both the datasets, wherever their timestamps missmatch. <cite>SaQC</cite> can handle those unaligned data
internally without introducing artificial fill values to them.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">saqc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">maint</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">maintpath</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">maint</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">maint</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">saqc</span><span class="o">.</span><span class="n">SaQC</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">maint</span><span class="p">])</span>  <span class="c1"># dataframes &quot;data&quot; and &quot;maint&quot; are integrated internally</span>
</pre></div>
</div>
<p>We can check out the fields, the newly generated <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC" title="saqc.SaQC"><code class="xref py py-class docutils literal notranslate"><span class="pre">SaQC</span></code></a> object contains as follows:</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span>
<span class="go">Index([&#39;sac254_raw&#39;, &#39;level_raw&#39;, &#39;water_temp_raw&#39;, &#39;maint&#39;], dtype=&#39;object&#39;, name=&#39;columns&#39;)</span>
</pre></div>
</div>
<p>The variables represent meassurements of <em>water level</em>, the <em>specific absorption coefficient</em> at 254 nm Wavelength,
the <em>water temperature</em> and there is also a variable, <em>maint</em>, that refers to time periods, where the <em>sac254</em> sensor
was maintained. Lets have a look at those:</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;maint&#39;</span><span class="p">]</span> 
<span class="go">Timestamp</span>
<span class="go">2016-01-10 11:15:00    2016-01-10 12:15:00</span>
<span class="go">2016-01-12 14:40:00    2016-01-12 15:30:00</span>
<span class="go">2016-02-10 13:40:00    2016-02-10 14:40:00</span>
<span class="go">2016-02-24 16:40:00    2016-02-24 17:30:00</span>
<span class="go">....                                  ....</span>
<span class="go">2017-10-17 08:55:00    2017-10-17 10:20:00</span>
<span class="go">2017-11-14 15:30:00    2017-11-14 16:20:00</span>
<span class="go">2017-11-27 09:10:00    2017-11-27 10:10:00</span>
<span class="go">2017-12-12 14:10:00    2017-12-12 14:50:00</span>
<span class="go">Name: maint, dtype: object</span>
</pre></div>
</div>
<p>Measurements collected while maintenance are not trustworthy, so any measurement taken, in any of the listed
intervals should be flagged right away. This can be achieved, with the <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.flagManual" title="saqc.SaQC.flagManual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">flagManual()</span></code></a> method. Also,
we will flag out-of-range values in the data with the <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.flagRange" title="saqc.SaQC.flagRange"><code class="xref py py-meth docutils literal notranslate"><span class="pre">flagRange()</span></code></a> method:</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">flagManual</span><span class="p">(</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">,</span> <span class="n">mdata</span><span class="o">=</span><span class="s1">&#39;maint&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maintenance&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">flagRange</span><span class="p">(</span><span class="s1">&#39;level_raw&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">flagRange</span><span class="p">(</span><span class="s1">&#39;water_temp_raw&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">flagRange</span><span class="p">(</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
<p>Lets check out the resulting flags for the <em>sac254</em> variable with the <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.plot" title="saqc.SaQC.plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code></a> method:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<figure class="align-default">
<a class="plot-directive center reference internal image-reference" href="../_images/MultivariateFlagging-3.png"><img alt="../_images/MultivariateFlagging-3.png" class="plot-directive center" src="../_images/MultivariateFlagging-3.png" style="width: 80%;" /></a>
</figure>
<p>Now we should figure out, what sampling rate the data is intended to have, by accessing the <em>_raw</em> variables
constituting the sensor data. Since <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.data" title="saqc.SaQC.data"><code class="xref py py-attr docutils literal notranslate"><span class="pre">saqc.SaQC.data</span></code></a> yields a
<a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html">pandas.DataFrame</a> like object, we can index it with
the desired variables as column names and have a look at the console output to get a first impression.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;level_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;water_temp_raw&#39;</span><span class="p">]]</span> 
<span class="go">                    sac254_raw |                     level_raw |                     water_temp_raw |</span>
<span class="go">============================== | ============================= | ================================== |</span>
<span class="go">Timestamp                      | Timestamp                     | Timestamp                          |</span>
<span class="go">2016-01-01 00:02:00    18.4500 | 2016-01-01 00:02:00   103.290 | 2016-01-01 00:02:00           4.84 |</span>
<span class="go">2016-01-01 00:17:00    18.6437 | 2016-01-01 00:17:00   103.285 | 2016-01-01 00:17:00           4.82 |</span>
<span class="go">2016-01-01 00:32:00    18.9887 | 2016-01-01 00:32:00   103.253 | 2016-01-01 00:32:00           4.81 |</span>
<span class="go">2016-01-01 00:47:00    18.8388 | 2016-01-01 00:47:00   103.210 | 2016-01-01 00:47:00           4.80 |</span>
<span class="go">2016-01-01 01:02:00    18.7438 | 2016-01-01 01:02:00   103.167 | 2016-01-01 01:02:00           4.78 |</span>
<span class="gp">... </span>                       <span class="o">...</span> <span class="o">|</span> <span class="o">...</span>                       <span class="o">...</span> <span class="o">|</span> <span class="o">...</span>                            <span class="o">...</span> <span class="o">|</span>
<span class="go">2017-12-31 22:47:00    43.2275 | 2017-12-31 22:47:00   186.060 | 2017-12-31 22:47:00           5.49 |</span>
<span class="go">2017-12-31 23:02:00    43.6937 | 2017-12-31 23:02:00   186.115 | 2017-12-31 23:02:00           5.49 |</span>
<span class="go">2017-12-31 23:17:00    43.6012 | 2017-12-31 23:17:00   186.137 | 2017-12-31 23:17:00           5.50 |</span>
<span class="go">2017-12-31 23:32:00    43.2237 | 2017-12-31 23:32:00   186.128 | 2017-12-31 23:32:00           5.51 |</span>
<span class="go">[70163]                          [70163]                         [70163]</span>

<span class="go">max: [70163 rows x 3 columns]</span>
</pre></div>
</div>
<p>The data seems to have a fairly regular sampling rate of <em>15</em> minutes at first glance.
But checking out values around <em>2017-10-29</em>, we notice, that the sampling rate seems not to be totally stable:</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;level_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;water_temp_raw&#39;</span><span class="p">]][</span><span class="s1">&#39;2017-10-29 07:00:00&#39;</span><span class="p">:</span><span class="s1">&#39;2017-10-29 09:00:00&#39;</span><span class="p">]</span> 
<span class="go">                    sac254_raw |                     level_raw |                     water_temp_raw |</span>
<span class="go">============================== | ============================= | ================================== |</span>
<span class="go">Timestamp                      | Timestamp                     | Timestamp                          |</span>
<span class="go">2017-10-29 07:02:00    40.3050 | 2017-10-29 07:02:00   112.570 | 2017-10-29 07:02:00          10.91 |</span>
<span class="go">2017-10-29 07:17:00    39.6287 | 2017-10-29 07:17:00   112.497 | 2017-10-29 07:17:00          10.90 |</span>
<span class="go">2017-10-29 07:32:00    39.5800 | 2017-10-29 07:32:00   112.460 | 2017-10-29 07:32:00          10.88 |</span>
<span class="go">2017-10-29 07:32:01    39.9750 | 2017-10-29 07:32:01   111.837 | 2017-10-29 07:32:01          10.70 |</span>
<span class="go">2017-10-29 07:47:00    39.1350 | 2017-10-29 07:47:00   112.330 | 2017-10-29 07:47:00          10.84 |</span>
<span class="go">2017-10-29 07:47:01    40.6937 | 2017-10-29 07:47:01   111.615 | 2017-10-29 07:47:01          10.68 |</span>
<span class="go">2017-10-29 08:02:00    40.4938 | 2017-10-29 08:02:00   112.040 | 2017-10-29 08:02:00          10.77 |</span>
<span class="go">2017-10-29 08:02:01    39.3337 | 2017-10-29 08:02:01   111.552 | 2017-10-29 08:02:01          10.68 |</span>
<span class="go">2017-10-29 08:17:00    41.5238 | 2017-10-29 08:17:00   111.835 | 2017-10-29 08:17:00          10.72 |</span>
<span class="go">2017-10-29 08:17:01    38.6963 | 2017-10-29 08:17:01   111.750 | 2017-10-29 08:17:01          10.69 |</span>
<span class="go">2017-10-29 08:32:01    39.4337 | 2017-10-29 08:32:01   112.027 | 2017-10-29 08:32:01          10.66 |</span>
</pre></div>
</div>
<p>Those instabilities do bias most statistical evaluations and it is common practice to apply some
<a class="reference internal" href="../funcs/resampling.html"><span class="doc">resampling functions</span></a> onto the data, to obtain a regularly spaced timestamp.
(See also the <a class="reference internal" href="DataRegularisation.html#data-regularisation"><span class="std std-ref">harmonization tutorial</span></a> for more informations
on that topic.)</p>
<p>We will apply <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.linear" title="saqc.SaQC.linear"><code class="xref py py-meth docutils literal notranslate"><span class="pre">linear</span> <span class="pre">harmonisation</span></code></a> to all the sensor data variables,
to interpolate pillar points of multiples of <em>15</em> minutes linearly.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">linear</span><span class="p">([</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;level_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;water_temp_raw&#39;</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;15min&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The resulting timeseries now has has regular timestamp.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">]</span> 
<span class="go">Timestamp</span>
<span class="go">2016-01-01 00:00:00          NaN</span>
<span class="go">2016-01-01 00:15:00    18.617873</span>
<span class="go">2016-01-01 00:30:00    18.942700</span>
<span class="go">2016-01-01 00:45:00    18.858787</span>
<span class="go">2016-01-01 01:00:00    18.756467</span>
<span class="go">                         ...</span>
<span class="go">2017-12-31 23:00:00    43.631540</span>
<span class="go">2017-12-31 23:15:00    43.613533</span>
<span class="go">2017-12-31 23:30:00    43.274033</span>
<span class="go">2017-12-31 23:45:00    43.674453</span>
<span class="go">2018-01-01 00:00:00          NaN</span>
<span class="go">Name: sac254_raw, Length: 70177, dtype: float64</span>
</pre></div>
</div>
<p>Since points, that were identified as malicous get excluded before the harmonization, the resulting regularly sampled
timeseries does not include them anymore:</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<figure class="align-default">
<a class="plot-directive center reference internal image-reference" href="../_images/MultivariateFlagging-5.png"><img alt="../_images/MultivariateFlagging-5.png" class="plot-directive center" src="../_images/MultivariateFlagging-5.png" style="width: 80%;" /></a>
</figure>
</section>
<section id="drift-correction">
<h2>Drift Correction<a class="headerlink" href="#drift-correction" title="Permalink to this headline">¶</a></h2>
<p>The variables <em>SAK254</em> and <em>Turbidity</em> show drifting behavior originating from dirt, that accumulates on the light
sensitive sensor surfaces over time. The effect, the dirt accumulation has on the measurement values, is assumed to be
properly described by an exponential model. The Sensors are cleaned periodocally, resulting in a periodical reset of
the drifting effect. The Dates and Times of the maintenance events are input to the method
<a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.correctDrift" title="saqc.SaQC.correctDrift"><code class="xref py py-meth docutils literal notranslate"><span class="pre">correctDrift()</span></code></a>, that will correct the data in between any two such maintenance intervals.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">correctDrift</span><span class="p">(</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;sac254_corrected&#39;</span><span class="p">,</span><span class="n">maintenance_field</span><span class="o">=</span><span class="s1">&#39;maint&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;exponential&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Check out the results for the year <em>2016</em></p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">][</span><span class="s1">&#39;2016&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sac254_corrected&#39;</span><span class="p">][</span><span class="s1">&#39;2016&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<figure class="align-default">
<img alt="../_images/MultivariateFlagging-7.png" class="plot-directive" src="../_images/MultivariateFlagging-7.png" />
</figure>
</section>
<section id="multivariate-flagging-procedure">
<h2>Multivariate Flagging Procedure<a class="headerlink" href="#multivariate-flagging-procedure" title="Permalink to this headline">¶</a></h2>
<p>We are basically following the <em>oddWater</em> procedure, as suggested in <em>Talagala, P.D. et al (2019): A Feature-Based
Procedure for Detecting Technical Outliers in Water-Quality Data From In Situ Sensors. Water Resources Research,
55(11), 8547-8568.</em></p>
<p>First, we define a transformation, we want the variables to be transformed with, to make them equally significant in
their common feature space. We go for the common pick of just <em>zScoring</em> the variables.
Therefor, we just import <em>scipys</em> <cite>zscore</cite> function and wrap it, so that it will be able to digest <em>nan</em> values,
without returning <em>nan</em>.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">zscore_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">zscore</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can pass the function to the <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.transform" title="saqc.SaQC.transform"><code class="xref py py-meth docutils literal notranslate"><span class="pre">transform()</span></code></a> method.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="s1">&#39;sac254_corrected&#39;</span><span class="p">,</span> <span class="s1">&#39;level_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;water_temp_raw&#39;</span><span class="p">],</span>
<span class="gp">... </span><span class="n">target</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sac254_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;level_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;water_temp_norm&#39;</span><span class="p">],</span> <span class="n">func</span><span class="o">=</span><span class="n">zscore_func</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;30D&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The idea of the multivariate flagging approach we are going for, is,
to assign any datapoint a score, derived from the distance this datapoint has to its <em>k</em> nearest
neighbors in feature space. We can do this, via the <a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.assignKNNScore" title="saqc.SaQC.assignKNNScore"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assignKNNScore()</span></code></a> method.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">assignKNNScore</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sac254_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;level_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;water_temp_norm&#39;</span><span class="p">],</span>
<span class="gp">... </span><span class="n">target</span><span class="o">=</span><span class="s1">&#39;kNNscores&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;30D&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Lets have a look at the resulting score variable.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;kNNscores&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<figure class="align-default">
<a class="plot-directive center reference internal image-reference" href="../_images/MultivariateFlagging-10.png"><img alt="../_images/MultivariateFlagging-10.png" class="plot-directive center" src="../_images/MultivariateFlagging-10.png" style="width: 80%;" /></a>
</figure>
<p>Those scores roughly correlate with the isolation of the scored points in the feature space. For example, have a look at
the projection of this feature space onto the 2 dimensional <em>sac</em> - <em>level</em> space, in november 2016:</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sac254_norm&#39;</span><span class="p">,</span> <span class="n">phaseplot</span><span class="o">=</span><span class="s1">&#39;level_norm&#39;</span><span class="p">,</span> <span class="n">xscope</span><span class="o">=</span><span class="s1">&#39;2016-11&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<figure class="align-default">
<a class="plot-directive center reference internal image-reference" href="../_images/MultivariateFlagging-11.png"><img alt="../_images/MultivariateFlagging-11.png" class="plot-directive center" src="../_images/MultivariateFlagging-11.png" style="width: 80%;" /></a>
</figure>
<p>We can clearly see some outliers, that seem to be isolated from the cloud of the normalish points. Since those outliers are
correlated with relatively high <em>kNNscores</em>, we could try to calculate a threshold that determines, how extreme an
<em>kNN</em> score has to be to qualify an outlier. Therefor, we will use the saqc-implementation of the
<a class="reference external" href="https://arxiv.org/pdf/1908.04000.pdf">STRAY</a> algorithm, which is available as the method:
<a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.flagByStray" title="saqc.SaQC.flagByStray"><code class="xref py py-meth docutils literal notranslate"><span class="pre">flagByStray()</span></code></a>. This method will mark some samples of the <cite>kNNscore</cite> variable as anomaly.
Subsequently we project this marks (or <em>flags</em>) on to the <em>sac</em> variable with a call to
<a class="reference internal" href="../_api/saqc.SaQC.html#saqc.SaQC.transferFlags" title="saqc.SaQC.transferFlags"><code class="xref py py-meth docutils literal notranslate"><span class="pre">transferFlags()</span></code></a>. For the sake of demonstration, we also project the flags
on the normalized <em>sac</em> and plot the flagged values in the <em>sac254_norm</em> - <em>level_norm</em> feature space.</p>
<div class="highlight-pycon3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">flagByStray</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;kNNscores&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;30D&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">transferFlags</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;kNNscores&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;sac254_corrected&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;STRAY&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="o">.</span><span class="n">transferFlags</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;kNNscores&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;sac254_norm&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;STRAY&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sac254_corrected&#39;</span><span class="p">,</span> <span class="n">xscope</span><span class="o">=</span><span class="s1">&#39;2016-11&#39;</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">qc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sac254_norm&#39;</span><span class="p">,</span> <span class="n">phaseplot</span><span class="o">=</span><span class="s1">&#39;level_norm&#39;</span><span class="p">,</span> <span class="n">xscope</span><span class="o">=</span><span class="s1">&#39;2016-11&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<figure class="align-center">
<a class="plot-directive reference internal image-reference" href="../_images/MultivariateFlagging-13.png"><img alt="../_images/MultivariateFlagging-13.png" class="plot-directive" src="../_images/MultivariateFlagging-13.png" style="width: 80%;" /></a>
</figure>
<figure class="align-default">
<a class="plot-directive center reference internal image-reference" href="../_images/MultivariateFlagging-14.png"><img alt="../_images/MultivariateFlagging-14.png" class="plot-directive center" src="../_images/MultivariateFlagging-14.png" style="width: 80%;" /></a>
</figure>
</section>
<section id="config">
<h2>Config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h2>
<p>To configure <cite>saqc</cite> to execute the above data processing and flagging steps, the config file would have to look
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">varname</span>                 <span class="p">;</span> <span class="n">test</span>
<span class="c1">#-----------------------;-------------------------------------------</span>
<span class="c1"># Data Preparation</span>
<span class="n">sac254_raw</span>              <span class="p">;</span> <span class="n">flagManual</span><span class="p">(</span><span class="n">mdata</span><span class="o">=</span><span class="s1">&#39;maint&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;closed&#39;</span><span class="p">)</span>
<span class="n">level_raw</span>               <span class="p">;</span> <span class="n">flagRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">water_temp_raw</span>          <span class="p">;</span> <span class="n">flagRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sac254_raw</span>              <span class="p">;</span> <span class="n">flagRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">level_raw</span>               <span class="p">;</span> <span class="n">linear</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;15min&#39;</span><span class="p">)</span>
<span class="n">water_temp_raw</span>          <span class="p">;</span> <span class="n">linear</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;15min&#39;</span><span class="p">)</span>
<span class="n">sac254_raw</span>              <span class="p">;</span> <span class="n">linear</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;15min&#39;</span><span class="p">)</span>
<span class="c1"># Drift Correcture</span>
<span class="n">sac254_raw</span>              <span class="p">;</span> <span class="n">correctDrift</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s1">&#39;sac254_corr&#39;</span><span class="p">,</span> <span class="n">maintenance_field</span><span class="o">=</span><span class="s1">&#39;maint&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;exponential&#39;</span><span class="p">)</span>
<span class="c1"># Multivariate Flagging Procedure</span>
<span class="n">level_z</span>                 <span class="p">;</span> <span class="n">transform</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;level_raw&#39;</span><span class="p">],</span> <span class="n">func</span><span class="o">=</span><span class="n">zScore</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;20D&#39;</span><span class="p">)</span>
<span class="n">water_z</span>                 <span class="p">;</span> <span class="n">transform</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;water_temp_raw&#39;</span><span class="p">],</span> <span class="n">func</span><span class="o">=</span><span class="n">zScore</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;20D&#39;</span><span class="p">)</span>
<span class="n">sac_z</span>                   <span class="p">;</span> <span class="n">transform</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sac254_raw&#39;</span><span class="p">],</span> <span class="n">func</span><span class="o">=</span><span class="n">zScore</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;20D&#39;</span><span class="p">)</span>
<span class="n">kNN_scores</span>              <span class="p">;</span> <span class="n">assignKNNScore</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;level_z&#39;</span><span class="p">,</span> <span class="s1">&#39;water_z&#39;</span><span class="p">,</span> <span class="s1">&#39;sac_z&#39;</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;20D&#39;</span><span class="p">)</span>
<span class="n">kNN_scores</span>              <span class="p">;</span> <span class="n">flagByStray</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;20D&#39;</span><span class="p">)</span>
<span class="n">level_raw</span>               <span class="p">;</span> <span class="n">transferFlags</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;kNN_scores&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;STRAY&#39;</span><span class="p">)</span>
<span class="n">sac254_corr</span>             <span class="p">;</span> <span class="n">transferFlags</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;kNN_scores&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;STRAY&#39;</span><span class="p">)</span>
<span class="n">water_temp_raw</span>          <span class="p">;</span> <span class="n">transferFlags</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;kNN_scores&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;STRAY&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/SaQCLogo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference external" href="https://git.ufz.de/rdm-software/saqc">Repository</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted/InstallationGuide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted/TutorialAPI.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted/TutorialCLI.html">Command Line Application</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Cookbooks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="DataRegularisation.html">Data Regularisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="OutlierDetection.html">Outlier Detection and Flagging</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Multivariate Flagging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-preparation">Data Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#drift-correction">Drift Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multivariate-flagging-procedure">Multivariate Flagging Procedure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#config">Config</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation/ConfigurationFiles.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/GenericFunctions.html">Generic Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/GlobalKeywords.html">Global Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/Customizations.html">Customizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/SourceTarget.html">Assigning results to new variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/FlaggingTranslation.html">Flags, History and Translations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SaQC</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/SaQC.html">Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/SaQCCore.html">Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/SaQCFunctions.html">Test Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/SaQCTranslation.html">Translations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/SaQCConstants.html">Constants</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../howtodoc/HowToDoc.html">Documentation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/WritingFunctions.html">Writing Functions</a></li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="OutlierDetection.html"
                          title="previous chapter">Outlier Detection and Flagging</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../documentation/ConfigurationFiles.html"
                          title="next chapter">Configuration Files</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/cookbooks/MultivariateFlagging.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../documentation/ConfigurationFiles.html" title="Configuration Files"
             >next</a> |</li>
        <li class="right" >
          <a href="OutlierDetection.html" title="Outlier Detection and Flagging"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SaQC 2.0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Multivariate Flagging</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Bert Palm, David Schäfer, Peter Lünenschloß, Florian Gransee.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>